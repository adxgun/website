<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">








    






<link rel="icon" type="image/ico" href="http://localhost:1313//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="http://localhost:1313//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313//apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    Building Docker Images Dynamically with Go | Hammed Adigun
    
</title>

<link rel="canonical" href="http://localhost:1313/posts/b_create_dynamic_image/"/>

<meta property="og:url" content="http://localhost:1313/posts/b_create_dynamic_image/">
  <meta property="og:site_name" content="Hammed Adigun">
  <meta property="og:title" content="Building Docker Images Dynamically with Go">
  <meta property="og:description" content="I recently started looking into ways of automating microservices app deployment and one of the many things i needed to automate is the famous docker build command. I understand that i could take advantage of the installed Docker client on the host computer by using os/exec package, but my idea isn’t that simple and its not really fun compared to using github.com/docker/docker/client — refer to as goDockerClient henceforth. This post contains the steps i followed to building docker images successfully with goDockerClient">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-08-22T00:00:00+00:00">
    <meta property="article:modified_time" content="2019-08-22T00:00:00+00:00">













<link rel="stylesheet" href="/assets/combined.min.0f4f5c64ee7100cff28e7c7366d922b5499829f72c91a53b9b17f236d85ad7e7.css" media="all">











    




</head>







<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="http://localhost:1313/">Hammed Adigun</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/projects" >
                /projects
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      




<div class="breadcrumbs"><a href="/">~</a><span class="breadcrumbs-separator">/</span><a href="/posts/">Posts</a><span class="breadcrumbs-separator">/</span>
        <a href="/posts/b_create_dynamic_image/">Building Docker Images Dynamically with Go</a></div>


<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">Building Docker Images Dynamically with Go</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2019-08-22T00:00:00&#43;00:00">22 Aug 2019</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <p>I recently started looking into ways of automating microservices app deployment and one of the many things i needed to automate is the famous docker build command. I understand that i could take advantage of the installed Docker client on the host computer by using os/exec package, but my idea isn’t that simple and its not really fun compared to using github.com/docker/docker/client — refer to as goDockerClient henceforth. This post contains the steps i followed to building docker images successfully with goDockerClient</p>
<h3 class="heading" id="understand-the-docker-buildcontext">
  Understand the Docker BuildContext
  <a class="anchor" href="#understand-the-docker-buildcontext">#</a>
</h3>
<p>After i spent some time checking out goDockerClient <a href="https://godoc.org/github.com/docker/docker/client">GoDoc</a>, i felt like i was ready to start building docker images dynamically but i was wrong. It wasn’t as trivial as the Doc made it look, i thought all i had to do was call client.ImageBuild(context.Context, buildContext, opts) specifying my Dockerfile in opts.Dockerfile , after few unsuccessful trials, i began digging deeper. Turns out buildContext which is of type io.Reader is suppose to be the content of the image i am trying to build. Initially, i was doing something like this</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="font-weight:bold">func</span> createBuildContext() (io.Reader, <span style="">error</span>) {
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// get current working dir</span>
</span></span><span style="display:flex;"><span>  wd, err := os.Getwd()
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">if</span> err != <span style="font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// resolve Dockerfile path</span>
</span></span><span style="display:flex;"><span>  path := filepath.join(wd, <span style="font-style:italic">&#34;Dockerfile&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">return</span> os.Open(path)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Using just the Dockerfile as buildContext will not work because the docker daemon expect the buildContext to be all the files you’ll need in your new docker image.</p>
<h3 class="heading" id="what-worked">
  What worked
  <a class="anchor" href="#what-worked">#</a>
</h3>
<p>After understanding what docker meant by buildContext the task at hand became easier. We just need a way to wrap all the files in a dir — BuildContext into an io.Reader so that we can easily send this to docker deamon and have our image built. Luckily, there is a helper function in goDockerClient that does just this, just give it a directory and this function would tar it and give you an io.Reader .</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="font-style:italic">&#34;github.com/docker/docker/pkg/archive&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">// createBuildContext archive a dir and return an io.Reader</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">func</span> createBuildContext(path <span style="">string</span>) (io.Reader, <span style="">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">return</span> archive.Tar(path, archive.Uncompressed)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The final solution. The code below results to a successful dynamic docker build</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="font-style:italic">// buildLocalImage build a docker image from the supplied `path` parameter.</span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">// The image built is intended to be pushed to a local docker registry.</span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">// This function assumes there is a Dockerfile in the dir</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">func</span> buildLocalImage(path <span style="">string</span>) <span style="">error</span> {
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// get current working dir, to resolve the path to Dockerfile</span>
</span></span><span style="display:flex;"><span>  wd, err := os.Getwd()
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">if</span> err != <span style="font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// create a docker buildContext by `archiving` the files</span>
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// the target dir</span>
</span></span><span style="display:flex;"><span>  buildCtx, err := createBuildContext(path)
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">if</span> err != <span style="font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// form a unique docker tag. the first string seg is the local docker registry host</span>
</span></span><span style="display:flex;"><span>  tag := fmt.Sprintf(<span style="font-style:italic">&#34;%s%s%s&#34;</span>, <span style="font-style:italic">&#34;docker-registry:5000/&#34;</span>, build.Name(), p.md5()[:6])
</span></span><span style="display:flex;"><span>  ctx := context.Background()
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// build image. reader can be used to get output from docker deamon</span>
</span></span><span style="display:flex;"><span>  reader, err := p.client.ImageBuild(ctx, buildCtx, types.ImageBuildOptions{
</span></span><span style="display:flex;"><span>     Dockerfile: <span style="font-style:italic">&#34;Dockerfile&#34;</span>, PullParent: <span style="font-weight:bold">true</span>, Tags: []<span style="">string</span>{tag}, Remove: <span style="font-weight:bold">true</span>, NoCache: <span style="font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">if</span> err != <span style="font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>	buf := make([]<span style="">byte</span>, 512)
</span></span><span style="display:flex;"><span>	_, err := reader.Body.Read(buf)
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">if</span> err != <span style="font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>	   <span style="font-weight:bold">if</span> err == io.EOF {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	    }
</span></span><span style="display:flex;"><span>	    log.Println(<span style="font-style:italic">&#34;error reading response &#34;</span>, err)
</span></span><span style="display:flex;"><span>	    <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="font-style:italic">// print outputs</span>
</span></span><span style="display:flex;"><span>  	log.Println(string(buf[:]))
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>  <span style="font-style:italic">// yay! no errors</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">return</span> <span style="font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Full code gist can be found here — <a href="https://gist.github.com/adigunhammedolalekan/354f31e7f9b53e6c76d09b2247d3ecad">https://gist.github.com/adigunhammedolalekan/354f31e7f9b53e6c76d09b2247d3ecad</a></p>
<p>Thank you.</p>

    
  </div>

  

  

  
  

<div class="single-pagination">
    <hr />

    <div class="flexnowrap">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/c_build_api_with_go/">
                        Build and Deploy a secure REST API with Go, Postgresql, JWT and GORM
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/posts/a_create_docker_auth/">
                        Creating Docker Registry Token Authentication Server with Go
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  
  





    




  <footer>
    


  </footer>

  
</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
